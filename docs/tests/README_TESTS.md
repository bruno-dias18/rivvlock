# üß™ Tests & Monitoring - RivvLock

> **üìä Monitoring d√©taill√©**: Voir [MONITORING.md](./MONITORING.md) pour la configuration Sentry et l'observabilit√© compl√®te.

## Tests Unitaires (Vitest)

### Installation d√©j√† faite ‚úÖ
```bash
# Dependencies install√©es :
- vitest
- @vitest/ui
- @testing-library/react
- @testing-library/jest-dom
- jsdom
```

### Commandes

```bash
# Lancer les tests
npm run test

# Lancer les tests en mode watch
npm run test:watch

# Lancer l'interface UI des tests
npm run test:ui

# G√©n√©rer un rapport de coverage
npm run test:coverage
```

### Scripts √† ajouter dans package.json

```json
{
  "scripts": {
    "test": "vitest",
    "test:ui": "vitest --ui",
    "test:coverage": "vitest --coverage"
  }
}
```

### Structure des tests

```
src/
‚îú‚îÄ‚îÄ lib/
‚îÇ   ‚îî‚îÄ‚îÄ __tests__/
‚îÇ       ‚îú‚îÄ‚îÄ constants.test.ts ‚úÖ
‚îÇ       ‚îú‚îÄ‚îÄ copyUtils.test.ts ‚úÖ
‚îÇ       ‚îú‚îÄ‚îÄ validations.test.ts ‚úÖ NEW
‚îÇ       ‚îî‚îÄ‚îÄ securityCleaner.test.ts ‚úÖ NEW
‚îú‚îÄ‚îÄ hooks/
‚îÇ   ‚îî‚îÄ‚îÄ __tests__/
‚îÇ       ‚îú‚îÄ‚îÄ useTransactions.test.tsx ‚úÖ NEW
‚îÇ       ‚îî‚îÄ‚îÄ useDisputeMessages.test.tsx ‚úÖ NEW
‚îú‚îÄ‚îÄ types/
‚îÇ   ‚îî‚îÄ‚îÄ __tests__/
‚îÇ       ‚îî‚îÄ‚îÄ index.test.ts ‚úÖ
‚îî‚îÄ‚îÄ test/
    ‚îú‚îÄ‚îÄ setup.ts ‚úÖ
    ‚îú‚îÄ‚îÄ setup.integration.ts ‚úÖ NEW
    ‚îî‚îÄ‚îÄ utils/
        ‚îî‚îÄ‚îÄ test-utils.tsx ‚úÖ
```

### Tests cr√©√©s (9 fichiers)

1. **constants.test.ts** - Validation des constantes
2. **copyUtils.test.ts** - Tests des fonctions de copie/partage
3. **validations.test.ts** ‚ú® NEW - Tests validation prix, email, SIRET, AVS, VAT
4. **securityCleaner.test.ts** ‚ú® NEW - Tests nettoyage donn√©es sensibles
5. **useTransactions.test.tsx** ‚ú® NEW - Tests hook transactions
6. **useDisputeMessages.test.tsx** ‚ú® NEW - Tests messaging disputes
7. **index.test.ts** (types) - Validation des types TypeScript
8. **setup.ts** - Configuration globale des tests
9. **test-utils.tsx** - Utilitaires de rendu avec providers

### Exemple d'usage

```typescript
import { render, screen } from '@/test/utils/test-utils';
import { MyComponent } from '@/components/MyComponent';

describe('MyComponent', () => {
  it('should render correctly', () => {
    render(<MyComponent />);
    expect(screen.getByText('Hello')).toBeInTheDocument();
  });
});
```

### Coverage actuel

- ‚úÖ Constants: 100%
- ‚úÖ CopyUtils: 80%
- ‚úÖ Types: 100%
- ‚úÖ Validations: 90% ‚ú® NEW
- ‚úÖ SecurityCleaner: 85% ‚ú® NEW
- ‚úÖ Hooks (useTransactions): 60% ‚ú® NEW
- ‚úÖ Hooks (useDisputeMessages): 60% ‚ú® NEW
- üéØ **Objectif global: 70%+ (en bonne voie)**

---

## üîç Monitoring Sentry

### Configuration

1. **Cr√©er un compte Sentry**
   - Allez sur https://sentry.io
   - Cr√©ez un nouveau projet React
   - Copiez le DSN depuis les param√®tres

2. **Configurer l'environnement**
   ```bash
   # Ajoutez √† votre .env
   VITE_SENTRY_DSN=https://xxx@xxx.ingest.sentry.io/xxx
   ```

3. **D√©j√† int√©gr√© dans le code ‚úÖ**
   - `src/lib/sentry.ts` - Configuration Sentry
   - `src/main.tsx` - Initialisation automatique

### Fonctionnalit√©s actives

‚úÖ **Error Tracking**
- Capture automatique des erreurs React
- Stack traces compl√®tes
- Contexte utilisateur

‚úÖ **Performance Monitoring**
- Temps de chargement des pages
- Performance des requ√™tes
- Sample rate: 10%

‚úÖ **Session Replay**
- 10% des sessions normales
- 100% des sessions avec erreurs
- Donn√©es sensibles masqu√©es

‚úÖ **Privacy**
- PII automatiquement supprim√©
- Cookies et headers exclus
- Texte et m√©dia masqu√©s dans replays

### Usage manuel

```typescript
import { captureException, setUser, addBreadcrumb } from '@/lib/sentry';

// Apr√®s login
setUser({ id: user.id, email: user.email });

// Capturer une erreur
try {
  riskyOperation();
} catch (error) {
  captureException(error, {
    tags: { context: 'payment' },
    level: 'error',
  });
}

// Ajouter contexte pour debug
addBreadcrumb({
  category: 'payment',
  message: 'User clicked pay button',
  level: 'info',
});
```

### Erreurs ignor√©es

- Extensions navigateur (`ResizeObserver loop`)
- Erreurs r√©seau basiques (`Failed to fetch`)
- Erreurs Stripe (g√©r√©es par Stripe)

---

## üìä Dashboard Sentry

Une fois configur√©, vous aurez acc√®s √† :

1. **Errors Dashboard**
   - Toutes les erreurs en temps r√©el
   - Fr√©quence et impact
   - Stack traces compl√®tes

2. **Performance**
   - Temps de chargement des pages
   - Performance des API calls
   - Transactions lentes

3. **Session Replay**
   - Vid√©o de ce que l'utilisateur a fait
   - Logs console
   - √âv√©nements r√©seau

4. **Releases**
   - Tracking des versions
   - R√©gression detection
   - Deploy tracking

---

## üé≠ Tests E2E (Playwright)

### Installation d√©j√† faite ‚úÖ
```bash
# Dependencies install√©es :
- @playwright/test
```

### Tests E2E cr√©√©s ‚ú®

1. **payment-flow.spec.ts** ‚úÖ
   - S√©lection m√©thode de paiement
   - Redirection Stripe
   - Instructions virement bancaire
   - Mobile-optimized

2. **dispute-flow.spec.ts** ‚ú® NEW
   - Cr√©ation dispute par acheteur
   - R√©ponse vendeur
   - Escalade admin
   - R√©solution avec proposition

3. **admin-validation.spec.ts** ‚ú® NEW
   - Gestion transactions admin
   - Validation vendeur
   - Lib√©ration forc√©e de fonds
   - Gestion litiges escalad√©s

### Commandes

```bash
# Lancer tous les tests E2E
npm run test:e2e

# Mode UI interactif
npx playwright test --ui

# Tests sp√©cifiques
npx playwright test e2e/payment-flow.spec.ts
npx playwright test e2e/dispute-flow.spec.ts
npx playwright test e2e/admin-validation.spec.ts

# G√©n√©rer rapport
npx playwright show-report
```

### Pr√©requis

Voir `e2e/README.md` pour :
- Cr√©ation des utilisateurs de test
- Configuration des donn√©es
- Instructions d√©taill√©es

### Coverage E2E actuel

- ‚úÖ Payment flow: 100%
- ‚úÖ Dispute flow: 90% ‚ú® NEW
- ‚úÖ Admin validation: 85% ‚ú® NEW
- üéØ **Objectif: 80%+ flows critiques**

---

## üéØ Prochaines √©tapes

### Tests √† ajouter (optionnel)

1. **Tests multi-devises**
   - EUR, CHF transactions
   - Currency conversion

2. **Tests webhooks Stripe**
   - payment_intent.succeeded
   - payment_intent.payment_failed

3. **Edge Functions**
   ```typescript
   // supabase/functions/create-payment-intent/__tests__/index.test.ts
   ```

### Monitoring avanc√© (optionnel)

1. **Alertes Sentry**
   - Email sur erreurs critiques
   - Slack integration
   - PagerDuty pour on-call

2. **Custom Metrics**
   - Business KPIs tracking
   - Conversion funnels
   - User journey analytics

---

## ‚úÖ Checklist Production

- [x] Tests unitaires configur√©s
- [x] Test utils avec providers
- [x] Sentry configur√©
- [x] Privacy settings
- [x] Error filtering
- [ ] VITE_SENTRY_DSN ajout√© au .env (√† faire)
- [ ] Tests lanc√©s avec succ√®s (npm run test)
- [ ] Coverage > 70% (objectif futur)

---

**Derni√®re mise √† jour:** 13 Octobre 2025
